name: Mirror upstream CLDR # snapshot â†’ cldr-upstream and strip cldr workflows

on:
  schedule:
    - cron: '0 0 1 * *'    # monthly, 1st at 00:00 UTC
  workflow_dispatch: {}
permissions:
  contents: write
jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine upstream default branch & SHA
        id: upstream
        shell: bash
        run: |
          set -euo pipefail
          UPSTREAM="https://github.com/unicode-org/cldr.git"
          DEF_REF="$(git ls-remote --symref "$UPSTREAM" HEAD | awk '/^ref:/ {print $2}')"
          DEF_BRANCH="${DEF_REF#refs/heads/}"
          SHA="$(git ls-remote "$UPSTREAM" "refs/heads/$DEF_BRANCH" | awk '{print $1}')"
          echo "branch=$DEF_BRANCH" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Fetch upstream tip (for archive)
        shell: bash
        run: |
          set -euo pipefail
          UPSTREAM="https://github.com/unicode-org/cldr.git"
          BR="${{ steps.upstream.outputs.branch }}"
          git fetch "$UPSTREAM" "refs/heads/$BR:refs/remotes/upstream/$BR"

      - name: Create sanitized snapshot branch (orphan) cldr-upstream
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          TARGET="cldr-upstream"
          SRC="refs/remotes/upstream/${{ steps.upstream.outputs.branch }}"

          # Start a fresh orphan branch (no history)
          git checkout --orphan "$TARGET"

          # Clean working tree WITHOUT removing .git
          # (remove everything at repo root except .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf -- {} +

          # Extract upstream snapshot into cwd
          git archive --format=tar "$SRC" | tar -x

          # Strip upstream workflows to avoid perms issues
          rm -rf .github/workflows || true

          # Add provenance marker
          mkdir -p .mirror
          printf "upstream_branch=%s\nupstream_sha=%s\nsynced_at=%sZ\n" \
            "${{ steps.upstream.outputs.branch }}" \
            "${{ steps.upstream.outputs.sha }}" \
            "$(date -u +%FT%T)" > .mirror/CLDR_SOURCE.txt

          git add -A
          git commit -m "Snapshot CLDR ${{ steps.upstream.outputs.branch }} @ ${{ steps.upstream.outputs.sha }} (workflows stripped)"

          git push -f origin "$TARGET"
GitHub - unicode-org/cldr: The home of the Unicode Common Locale Data Repository
The home of the Unicode Common Locale Data Repository - unicode-org/cldr
 
